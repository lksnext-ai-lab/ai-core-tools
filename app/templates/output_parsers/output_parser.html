{% extends "app_settings/app_settings_base.html" %}

{% block app_settings_content %}

<script src="{{ url_for('static', filename='js/output_parser_validator.js') }}"></script>

<div class="row">
    <div class="col-6">
        <div class="card shadow mb-4">
            <div class="card-header border-bottom">
                <h5 class="mb-0">Data Structure: {{parser.name}}</h5>
            </div>
            <form action="{{ url_for('output_parsers.app_output_parser', app_id=app_id, parser_id=parser.parser_id) }}" method="POST" onsubmit="return OutputParserValidator.validateForm()">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="form-label">Name<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" placeholder="Name..." value="{{parser.name}}" name="name" required pattern="^[a-zA-Z0-9_]+$" title="Solo se permiten letras, números y guiones bajos">
                        </div>

                        <div class="col-md-12 mb-4">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" placeholder="Description..." value="{{parser.description}}" name="description">
                        </div>

                        <div class="col-12">
                            <table class="table" id="fieldsTable">
                                <thead>
                                    <tr>
                                        <th>Field Name</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if parser.fields %}
                                        {% for field in parser.fields %}
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control" name="field_name" value="{{field.name}}"
                                                       pattern="^[a-zA-Z0-9_]+$" title="Solo se permiten letras, números y guiones bajos">
                                            </td>
                                            <td>
                                                <select class="form-control field-type" name="field_type" onchange="toggleListItemType(this)">
                                                    <option value="str" {% if field.type == 'str' %}selected{% endif %}>String</option>
                                                    <option value="int" {% if field.type == 'int' %}selected{% endif %}>Integer</option>
                                                    <option value="float" {% if field.type == 'float' %}selected{% endif %}>Float</option>
                                                    <option value="bool" {% if field.type == 'bool' %}selected{% endif %}>Boolean</option>
                                                    <option value="date" {% if field.type == 'date' %}selected{% endif %}>Date</option>
                                                    <option value="list" {% if field.type == 'list' %}selected{% endif %}>List</option>
                                                    {% for parser in available_parsers %}
                                                    <option value="parser:{{parser.parser_id}}" 
                                                            {% if field.type == 'parser' and field.parser_id == parser.parser_id %}selected{% endif %}>
                                                        {{parser.name}}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                <span class="list-type-label" style="display: none;">
                                                    Tipo de elementos en la lista:
                                                </span>
                                                <select name="list_item_type" style="display: none;">
                                                    <option value="str" {% if field.list_item_type == 'str' %}selected{% endif %}>String</option>
                                                    <option value="int" {% if field.list_item_type == 'int' %}selected{% endif %}>Integer</option>
                                                    <option value="float" {% if field.list_item_type == 'float' %}selected{% endif %}>Float</option>
                                                    {% for parser in available_parsers %}
                                                    <option value="parser:{{parser.parser_id}}" 
                                                            {% if field.list_item_type == 'parser' and field.list_item_parser_id == parser.parser_id %}selected{% endif %}>
                                                        {{parser.name}}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" name="field_description" value="{{field.description}}">
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-danger btn-sm deleteFieldBtn">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                </tbody>
                            </table>
                            <button type="button" class="btn btn-secondary" id="addFieldBtn">Add Field</button>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <input type="submit" class="btn btn-primary" value="Save" />
                    <a href="{{ url_for('output_parsers.app_output_parsers', app_id=app_id) }}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleListItemType(selectElement) {
    const listItemTypeSelect = selectElement.nextElementSibling.nextElementSibling;
    const listTypeLabel = selectElement.nextElementSibling;
    
    if (selectElement.value === 'list') {
        listTypeLabel.style.display = 'inline';
        listItemTypeSelect.style.display = 'inline';
    } else {
        listTypeLabel.style.display = 'none';
        listItemTypeSelect.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const addFieldBtn = document.getElementById('addFieldBtn');
    const fieldsTable = document.getElementById('fieldsTable').getElementsByTagName('tbody')[0];

    // Función para actualizar el estado del botón añadir
    function updateAddButtonState() {
        const rowCount = fieldsTable.getElementsByTagName('tr').length;
        addFieldBtn.disabled = rowCount >= 10;
    }

    // Manejador para eliminar campos
    fieldsTable.addEventListener('click', function(e) {
        if (e.target.closest('.deleteFieldBtn')) {
            e.target.closest('tr').remove();
            updateAddButtonState();
        }
    });

    addFieldBtn.addEventListener('click', function() {
        const rowCount = fieldsTable.getElementsByTagName('tr').length;
        if (rowCount >= 10) return;

        const newRow = fieldsTable.insertRow();
        newRow.innerHTML = `
            <td><input type="text" class="form-control" name="field_name" 
                       pattern="^[a-zA-Z0-9_]+$" title="Solo se permiten letras, números y guiones bajos"></td>
            <td>
                <select class="form-control field-type" name="field_type" onchange="toggleListItemType(this)">
                    <option value="str">String</option>
                    <option value="int">Integer</option>
                    <option value="float">Float</option>
                    <option value="bool">Boolean</option>
                    <option value="date">Date</option>
                    <option value="list">List</option>
                    {% for parser in available_parsers %}
                    <option value="parser:{{parser.parser_id}}">{{parser.name}}</option>
                    {% endfor %}
                </select>
                <span class="list-type-label" style="display: none;">Tipo de elementos en la lista:</span>
                <select name="list_item_type" style="display: none;">
                    <option value="str">str</option>
                    <option value="int">int</option>
                    <option value="float">float</option>
                    {% for parser in available_parsers %}
                    <option value="parser:{{parser.parser_id}}">{{parser.name}}</option>
                    {% endfor %}
                </select>
            </td>
            <td><input type="text" class="form-control" name="field_description"></td>
            <td>
                <button type="button" class="btn btn-danger btn-sm deleteFieldBtn">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        updateAddButtonState();
    });

    // Inicializar el estado del botón
    updateAddButtonState();

    // Inicializar el estado de los campos list
    document.querySelectorAll('.field-type').forEach(function(select) {
        if (select.value === 'list') {
            toggleListItemType(select);
        }
    });

    // Inicializar el gestor de campos
    const fieldManager = new OutputParserFieldManager();
});
</script>

{% endblock %} 