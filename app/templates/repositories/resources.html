{% extends "base.html" %}

{% block content %}

<div class="row">
    <div class="col-2">
        {% include 'repositories/repo_menu.html' %}
    </div>
    <div class="col-10">
        <div class="d-sm-flex justify-content-between align-items-center">
            <h1 class="h4 mb-2 mb-sm-0">Resources</h1>
        </div>

        <table class="table table-fixed">
            <thead>
                <tr>
                    <th scope="col">Name</th>
                    <th scope="col">URI</th>
                    <th scope="col">Type</th>
                    <th scope="col">Status</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for resource in repo.resources %}
                <tr>
                    <td>
                        <a href="{{url_for('repositories.resource_download', app_id=session['app_id'], repository_id=repo.repository_id, resource_id=resource.resource_id)}}">{{resource.name}}</a>
                    </td>
                    <td>
                        {{resource.uri}}
                    </td>
                    <td>{{resource.type}}</td>
                    <td>{{resource.status}}</td>
                    <td>
                        <button type="button" class="btn btn-primary inah-desc" data-bs-toggle="modal"
                            data-bs-target="#description-modal" id="{{resource.resource_id}}">
                            Edit
                        </button>
                        <a href="{{url_for('repositories.resource_delete',app_id=session['app_id'], repository_id=repo.repository_id, resource_id=resource.resource_id)}}"
                            class="btn btn-danger">Delete</a>

                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Unified File Upload Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Upload Files</h5>
            </div>
            <div class="card-body">
                <form
                    action="{{url_for('repositories.resource_create_multiple', app_id=session['app_id'], repository_id=repo.repository_id)}}"
                    method="POST" enctype="multipart/form-data" id="filesForm">
                    <div class="mb-3">
                        <label for="files" class="form-label">Files</label>
                        <input type="file" class="form-control" id="files" name="files" 
                               accept=".pdf,.docx,.txt" multiple required>
                        <div class="form-text">Select one or multiple files. Supported formats: PDF, DOCX (Word), TXT</div>
                    </div>
                    <div id="filesList" class="mb-3" style="display: none;">
                        <h6>Selected Files (click on names to edit):</h6>
                        <div id="filesContainer" class="border rounded p-3">
                            <!-- Files will be added here dynamically -->
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success" id="uploadBtn" disabled>Upload Files</button>
                </form>
            </div>
        </div>

        <script>
            let selectedFiles = [];
            let fileNames = new Map(); // Store custom names

            // Show selected files with editable names
            document.getElementById('files').addEventListener('change', function(e) {
                const filesList = document.getElementById('filesList');
                const filesContainer = document.getElementById('filesContainer');
                const uploadBtn = document.getElementById('uploadBtn');
                const files = e.target.files;
                
                selectedFiles = Array.from(files);
                fileNames.clear();
                
                if (files.length > 0) {
                    filesContainer.innerHTML = '';
                    
                    selectedFiles.forEach((file, index) => {
                        const fileExtension = file.name.substring(file.name.lastIndexOf('.'));
                        const fileNameWithoutExt = file.name.substring(0, file.name.lastIndexOf('.'));
                        
                        // Store original name without extension
                        fileNames.set(index, fileNameWithoutExt);
                        
                        const fileDiv = document.createElement('div');
                        fileDiv.className = 'mb-2 p-2 border rounded';
                        fileDiv.innerHTML = `
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <input type="text" 
                                               class="form-control file-name-input" 
                                               value="${fileNameWithoutExt}" 
                                               data-index="${index}"
                                               placeholder="Enter file name">
                                        <span class="input-group-text">${fileExtension}</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-file" data-index="${index}">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        filesContainer.appendChild(fileDiv);
                    });
                    
                    // Add event listeners for name changes
                    filesContainer.querySelectorAll('.file-name-input').forEach(input => {
                        input.addEventListener('input', function() {
                            const index = parseInt(this.dataset.index);
                            fileNames.set(index, this.value.trim());
                            validateFileNames();
                        });
                    });
                    
                    // Add event listeners for remove buttons
                    filesContainer.querySelectorAll('.remove-file').forEach(button => {
                        button.addEventListener('click', function() {
                            const index = parseInt(this.dataset.index);
                            removeFile(index);
                        });
                    });
                    
                    filesList.style.display = 'block';
                    uploadBtn.disabled = false;
                    validateFileNames();
                } else {
                    filesList.style.display = 'none';
                    uploadBtn.disabled = true;
                }
            });

            function removeFile(indexToRemove) {
                // Remove from selectedFiles array
                selectedFiles = selectedFiles.filter((_, index) => index !== indexToRemove);
                
                // Update fileNames map with new indices
                const newFileNames = new Map();
                let newIndex = 0;
                fileNames.forEach((name, oldIndex) => {
                    if (oldIndex !== indexToRemove) {
                        newFileNames.set(newIndex, name);
                        newIndex++;
                    }
                });
                fileNames = newFileNames;
                
                // Recreate the file list display
                const filesContainer = document.getElementById('filesContainer');
                const uploadBtn = document.getElementById('uploadBtn');
                
                if (selectedFiles.length === 0) {
                    document.getElementById('filesList').style.display = 'none';
                    uploadBtn.disabled = true;
                    return;
                }
                
                // Refresh the display
                filesContainer.innerHTML = '';
                selectedFiles.forEach((file, index) => {
                    const fileExtension = file.name.substring(file.name.lastIndexOf('.'));
                    const currentName = fileNames.get(index);
                    
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'mb-2 p-2 border rounded';
                    fileDiv.innerHTML = `
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control file-name-input" 
                                           value="${currentName}" 
                                           data-index="${index}"
                                           placeholder="Enter file name">
                                    <span class="input-group-text">${fileExtension}</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-sm btn-outline-danger remove-file" data-index="${index}">
                                    Remove
                                </button>
                            </div>
                        </div>
                    `;
                    
                    filesContainer.appendChild(fileDiv);
                });
                
                // Re-add event listeners
                filesContainer.querySelectorAll('.file-name-input').forEach(input => {
                    input.addEventListener('input', function() {
                        const index = parseInt(this.dataset.index);
                        fileNames.set(index, this.value.trim());
                        validateFileNames();
                    });
                });
                
                filesContainer.querySelectorAll('.remove-file').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        removeFile(index);
                    });
                });
                
                validateFileNames();
            }

            function validateFileNames() {
                const uploadBtn = document.getElementById('uploadBtn');
                let isValid = true;
                const names = Array.from(fileNames.values());
                
                // Check for empty names
                names.forEach(name => {
                    if (!name || name.trim() === '') {
                        isValid = false;
                    }
                });
                
                // Check for duplicate names
                const uniqueNames = new Set(names);
                if (uniqueNames.size !== names.length) {
                    isValid = false;
                }
                
                uploadBtn.disabled = !isValid;
                
                // Show validation messages
                const existingAlert = document.querySelector('.file-validation-alert');
                if (existingAlert) {
                    existingAlert.remove();
                }
                
                if (!isValid) {
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-warning file-validation-alert mt-2';
                    alert.innerHTML = 'Please ensure all files have unique, non-empty names.';
                    document.getElementById('filesContainer').appendChild(alert);
                }
            }

            // Intercept form submission to add custom names
            document.getElementById('filesForm').addEventListener('submit', function(e) {
                // Remove any existing hidden inputs for custom names
                const existingInputs = this.querySelectorAll('input[name^="custom_names["]');
                existingInputs.forEach(input => input.remove());
                
                // Create hidden inputs for custom names
                selectedFiles.forEach((file, index) => {
                    const customName = fileNames.get(index);
                    if (customName && customName.trim() !== '') {
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = `custom_names[${index}]`;
                        hiddenInput.value = customName;
                        this.appendChild(hiddenInput);
                    }
                });
            });
        </script>
    </div>
</div>

<style>
    .table-fixed {
        table-layout: fixed;
        width: 100%;
    }
    .table-fixed th:nth-child(2), /* Columna URI */
    .table-fixed td:nth-child(2) {
        width: 30%; /* Ajusta este valor seg√∫n tus necesidades */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>
{% endblock %}