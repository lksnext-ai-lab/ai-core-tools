{% extends "base.html" %}

{% block content %}

<div class="row">
    <!-- Left Column: Chat Interface -->
    <div class="col-8">

        <div class="card shadow mb-4">
            <!-- Card header -->
            <div class="card-header border-bottom">
                <h5 class="mb-0">Playground: {{agent.name}}</h5>
            </div>
            <!-- Card body -->
            <div class="card-body">
                <div class="row">
                    <!-- Information item -->
                    <div class="col-12">
                        <ul class="list-group list-group-borderless">
                            <li class="list-group-item">
                                <span>System prompt: </span>
                                <div class="d-flex align-items-center">
                                    <p class="h6 fw-normal mb-0 text-truncate" style="max-width: 500px;">
                                        {{agent.system_prompt}}</p>
                                    <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal"
                                        data-bs-target="#systemPromptModal">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="col-12">
                        <ul class="list-group list-group-borderless">
                            <li class="list-group-item">
                                <span>Prompt template: </span>
                                <div class="d-flex align-items-center">
                                    <p class="h6 fw-normal mb-0 text-truncate" style="max-width: 500px;">
                                        {{agent.prompt_template}}</p>
                                    <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal"
                                        data-bs-target="#promptTemplateModal">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="col-12">
                        <ul class="list-group list-group-borderless">
                            <li class="list-group-item">
                                <span>Formato de salida: </span>
                                {% if agent.output_parser %}
                                <div class="mt-2">
                                    <p class="mb-2"><strong>Nombre de la clase:</strong> {{agent.output_parser.name}}
                                    </p>
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Nombre del campo</th>
                                                <th>Tipo</th>
                                                <th>Descripción</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for field in agent.output_parser.fields %}
                                            <tr>
                                                <td>{{field.name}}</td>
                                                <td><code>{{field.type}}</code></td>
                                                <td>{{field.description}}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <p class="h6 fw-normal mb-0">None</p>
                                {% endif %}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow">
            <!-- Card header -->
            <div class="card-header border-bottom">
                <h5 class="card-header-title">Test the agent...</h5>
                <button id="reset-btn" class="btn btn-sm btn-outline-danger float-end">
                    <i class="fas fa-trash"></i> Reset Conversation
                </button>
            </div>

            <!-- Card body START -->
            <div class="card-body">
                <div>
                    <div class="bg-light border border-secondary border-opacity-25 p-3 rounded  mt-4" id="referenece">
                        <!-- Avatar -->
                        <div class="d-sm-flex align-items-center">
                            <div class="avatar avatar-xs flex-shrink-0">
                                <img class="avatar-img rounded-circle" src="/static/img/mattin-small.png" alt="avatar">
                            </div>
                            <!-- Info -->
                            <h6 class="mb-0 ms-2" id="ref-name">{{agent.name}}</h6>
                        </div>
                        <!-- Info -->
                        <div class="hstack gap-4 gap-md-5 flex-wrap mt-2">
                            <div>
                                <p class="mb-0" id="ref-text">Hello, I am {{agent.name}} agent... May I help you?</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="collapseComment">
                    
                    <div class="d-flex mt-3">
                        <textarea id="question" class="form-control mb-0" placeholder="Add a comment..." rows="2"
                            spellcheck="false"></textarea>
                        <button id="send-btn" class="btn btn-sm btn-primary ms-2 px-4 mb-0 flex-shrink-0"><i
                                class="fas fa-paper-plane fs-5"></i></button>
                    </div>
                    {% if agent.silo and agent.silo.metadata_definition %}
                    <div class="mt-3">
                        <h6>Filter by metadata:</h6>
                        <div class="row">
                            {% for field in agent.silo.metadata_definition.fields %}
                            <div class="col-md-4 mb-2">
                                <label for="filter_{{ field.name }}" class="form-label">
                                    <span class="fw-bold">{{ field.name }}</span>
                                    <small class="text-muted d-block">{{ field.description }}</small>
                                </label>
                                <input type="text" class="form-control form-control-sm" 
                                    id="filter_{{ field.name }}" 
                                    data-field-type="{{ field.type }}">
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

            </div>
            <!-- Card body END -->
        </div>

    </div>

    <!-- Right Column: File Management -->
    <div class="col-4">
        <div class="card shadow">
            <div class="card-header border-bottom">
                <h6 class="mb-0">
                    <i class="fas fa-paperclip"></i> File Attachments
                </h6>
            </div>
            <div class="card-body">
                
                <!-- File Upload Section -->
                <div class="mb-3">
                    <div class="card border-dashed">
                        <div class="card-body text-center p-3">
                            <div class="file-upload-area" id="fileUploadArea">
                                <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                <h6 class="mb-1">Drag & Drop files</h6>
                                <p class="text-muted mb-2 small">or click to browse</p>
                                <input type="file" id="fileInput" multiple class="d-none" accept=".pdf,.txt,.md,.png,.jpg,.jpeg,.doc,.docx">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-folder-open"></i> Choose Files
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attached Files List -->
                <div id="attachedFilesSection" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Attached Files</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="clearAllFiles">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                    <div id="attachedFilesList" class="list-group list-group-flush">
                        <!-- Files will be added here dynamically -->
                    </div>
                </div>

                <!-- File Info -->
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Supported formats: PDF, TXT, MD, PNG, JPG, DOC, DOCX
                    </small>
                </div>

            </div>
        </div>
    </div>

</div>

<script>
    var cont = 0;
    var attachedFiles = new Map(); // Store file references: {fileReference: {filename, contentType, uploadedAt}}
    
    // File Upload Functionality
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('fileInput');
    const attachedFilesSection = document.getElementById('attachedFilesSection');
    const attachedFilesList = document.getElementById('attachedFilesList');
    
    // Drag and drop functionality
    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.classList.add('border-primary');
        fileUploadArea.style.backgroundColor = '#f8f9fa';
    });
    
    fileUploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('border-primary');
        fileUploadArea.style.backgroundColor = '';
    });
    
    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('border-primary');
        fileUploadArea.style.backgroundColor = '';
        
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });
    
    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
    });
    
    function handleFiles(files) {
        files.forEach(file => {
            uploadFile(file);
        });
    }
    
    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        // Show loading state
        const fileItem = createFileItem(file, 'uploading');
        attachedFilesList.appendChild(fileItem);
        updateAttachedFilesVisibility();
        
        fetch('/api/app/{{app_id}}/attach-file/{{agent.agent_id}}', {
            method: 'POST',
            credentials: 'include',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Upload failed: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Update file item with success state
            updateFileItem(fileItem, file.name, data.file_reference, 'success');
            attachedFiles.set(data.file_reference, {
                filename: file.name,
                contentType: data.content_type,
                uploadedAt: new Date().toISOString()
            });
        })
        .catch(error => {
            console.error('Upload error:', error);
            updateFileItem(fileItem, file.name, null, 'error', error.message);
        });
    }
    
    function createFileItem(file, status) {
        const fileItem = document.createElement('div');
        fileItem.className = 'list-group-item d-flex align-items-center p-2';
        fileItem.innerHTML = `
            <div class="flex-grow-1">
                <div class="d-flex align-items-center">
                    <i class="fas fa-file me-2"></i>
                    <span class="filename small">${file.name}</span>
                </div>
                <div class="status-text text-muted small"></div>
            </div>
            <div class="file-actions">
                <button type="button" class="btn btn-sm btn-outline-danger remove-file" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        return fileItem;
    }
    
    function updateFileItem(fileItem, filename, fileReference, status, errorMessage = '') {
        const statusText = fileItem.querySelector('.status-text');
        const removeBtn = fileItem.querySelector('.remove-file');
        
        switch(status) {
            case 'uploading':
                statusText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                break;
            case 'success':
                statusText.innerHTML = '<i class="fas fa-check text-success"></i> Ready';
                removeBtn.style.display = 'block';
                removeBtn.onclick = () => removeFile(fileReference, fileItem);
                fileItem.dataset.fileReference = fileReference;
                break;
            case 'error':
                statusText.innerHTML = `<i class="fas fa-exclamation-triangle text-danger"></i> ${errorMessage}`;
                removeBtn.style.display = 'block';
                removeBtn.onclick = () => fileItem.remove();
                break;
        }
    }
    
    function removeFile(fileReference, fileItem) {
        fetch(`/api/app/{{app_id}}/detach-file/{{agent.agent_id}}/${fileReference}`, {
            method: 'DELETE',
            credentials: 'include'
        })
        .then(response => {
            if (response.ok) {
                attachedFiles.delete(fileReference);
                fileItem.remove();
                updateAttachedFilesVisibility();
            } else {
                throw new Error('Failed to remove file');
            }
        })
        .catch(error => {
            console.error('Remove file error:', error);
            alert('Failed to remove file. Please try again.');
        });
    }
    
    function updateAttachedFilesVisibility() {
        if (attachedFilesList.children.length > 0) {
            attachedFilesSection.style.display = 'block';
        } else {
            attachedFilesSection.style.display = 'none';
        }
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Clear all files
    document.getElementById('clearAllFiles').addEventListener('click', () => {
        if (confirm('Are you sure you want to remove all attached files?')) {
            const promises = Array.from(attachedFiles.keys()).map(fileReference => 
                fetch(`/api/app/{{app_id}}/detach-file/{{agent.agent_id}}/${fileReference}`, {
                    method: 'DELETE',
                    credentials: 'include'
                })
            );
            
            Promise.all(promises)
                .then(() => {
                    attachedFiles.clear();
                    attachedFilesList.innerHTML = '';
                    updateAttachedFilesVisibility();
                })
                .catch(error => {
                    console.error('Clear files error:', error);
                    alert('Failed to clear some files. Please try again.');
                });
        }
    });
    
    // Load existing attached files on page load
    function loadAttachedFiles() {
        fetch('/api/app/{{app_id}}/attached-files/{{agent.agent_id}}', {
            method: 'GET',
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.files && Object.keys(data.files).length > 0) {
                Object.entries(data.files).forEach(([fileReference, fileInfo]) => {
                    attachedFiles.set(fileReference, fileInfo);
                    const fileItem = createFileItem({name: fileInfo.filename, size: 0}, 'success');
                    updateFileItem(fileItem, fileInfo.filename, fileReference, 'success');
                    attachedFilesList.appendChild(fileItem);
                });
                updateAttachedFilesVisibility();
            }
        })
        .catch(error => {
            console.error('Load attached files error:', error);
        });
    }
    
    // Load files on page load
    loadAttachedFiles();
    
    // Add reset functionality
    $('#reset-btn').click(function() {
        // Disable button while processing
        $('#reset-btn').prop('disabled', true);
        
        fetch('/api/app/{{app_id}}/reset/{{agent.agent_id}}', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to reset conversation');
            }
            return response.json();
        })
        .then(data => {
            // Remove all conversation divs except the initial one
            $('[id^="referenece-"]').remove();
            $('[id^="loading-"]').remove();
            $('[id^="error-"]').remove();
            cont = 0;
            
            // Clear attached files
            attachedFiles.clear();
            attachedFilesList.innerHTML = '';
            updateAttachedFilesVisibility();
            
            // Show success message
            var successDiv = $('#referenece').clone();
            successDiv.attr('id', 'success-' + cont);
            $('#ref-name', successDiv).text('System');
            $('#ref-text', successDiv).html('<div class="text-success">Conversation reset successfully</div>');
            $('#referenece').parent().append(successDiv);
            
            // Remove success message after 3 seconds
            setTimeout(() => {
                $('#success-' + cont).remove();
            }, 3000);
        })
        .catch(error => {
            console.error('Error resetting conversation:', error);
            alert('Failed to reset conversation. Please try again.');
        })
        .finally(() => {
            $('#reset-btn').prop('disabled', false);
        });
    });

    $('#send-btn').click(function () {
        // Deshabilitar el botón mientras se procesa
        $('#send-btn').prop('disabled', true);
        
        var question = $('#question').val();
        console.log('Sending question:', question);
        
        // Limpiar el input inmediatamente después de obtener su valor
        $('#question').val('');

        // Collect filter values if they exist
        var search_params = null;
        {% if agent.silo and agent.silo.metadata_definition %}
        var filter = {};
        {% for field in agent.silo.metadata_definition.fields %}
        var value = $('#filter_{{ field.name }}').val();
        if (value) {
            filter['{{ field.name }}'] = value;
        }
        {% endfor %}
        if (Object.keys(filter).length > 0) {
            search_params = { filter: filter };
        }
        {% endif %}
        
        // Collect file references
        var file_references = Array.from(attachedFiles.keys());
        
        // Crear y mostrar el div de la pregunta
        var qDiv = $('#referenece').clone();
        qDiv.attr('id', 'referenece-' + cont);
        cont++;
        $('#ref-name', qDiv).text('You said...');
        
        // Add file attachment indicators to the message
        var messageText = question;
        if (file_references.length > 0) {
            messageText += '<br><small class="text-muted"><i class="fas fa-paperclip"></i> ' + 
                          file_references.length + ' file(s) attached</small>';
        }
        $('#ref-text', qDiv).html(messageText);
        $('#referenece').parent().append(qDiv);

        // Crear y mostrar un div de "loading"
        var loadingDiv = $('#referenece').clone();
        loadingDiv.attr('id', 'loading-' + cont);
        $('#ref-name', loadingDiv).text('{{agent.name}}');
        $('#ref-text', loadingDiv).html('<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2" role="status"></div>Thinking...</div>');
        $('#referenece').parent().append(loadingDiv);

        $("html, body").animate({
            scrollTop: $(document).height() - $(window).height()
        }, 'slow');

        // Hacer la petición con timeout
        const timeoutDuration = 600000; // 10 minutos
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutDuration);

        fetch('/api/app/{{app_id}}/call/{{agent.agent_id}}', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                question: question,
                search_params: search_params,
                file_references: file_references
            }),
            signal: controller.signal
        })
        .then(async response => {
            clearTimeout(timeoutId);
            if (!response.ok) {
                // Intentar obtener el mensaje de error del servidor
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `Error del servidor: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Eliminar el div de loading
            loadingDiv.remove();
            
            // Crear el div de respuesta
            var respDiv = $('#referenece').clone();
            respDiv.attr('id', 'referenece-' + cont);
            cont++;
            
            // Add attachment processing info if files were processed
            var responseText = data["generated_text"];
            if (data.metadata && data.metadata.attachments_processed) {
                responseText += '<br><small class="text-muted"><i class="fas fa-check"></i> ' + 
                               data.metadata.attachment_count + ' file(s) processed</small>';
            }
            
            $('#ref-text', respDiv).html(responseText);
            $('#referenece').parent().append(respDiv);

            $("html, body").animate({
                scrollTop: $(document).height() - $(window).height()
            }, 'slow');
        })
        .catch(error => {
            // Eliminar el div de loading
            loadingDiv.remove();
            
            // Mostrar error en un nuevo div con más detalles
            var errorDiv = $('#referenece').clone();
            errorDiv.attr('id', 'error-' + cont);
            $('#ref-name', errorDiv).text('Error');
            $('#ref-text', errorDiv).html(`
                <div class="text-danger">
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><small>Si el problema persiste, por favor contacte al administrador.</small></p>
                </div>
            `);
            $('#referenece').parent().append(errorDiv);
            
            console.error('Error detallado:', error);
        })
        .finally(() => {
            // Solo habilitar el botón ya que el input se limpió antes
            $('#send-btn').prop('disabled', false);
        });
    });

</script>

<style>
.border-dashed {
    border: 2px dashed #dee2e6 !important;
    transition: all 0.3s ease;
}

.border-dashed:hover {
    border-color: #0d6efd !important;
    background-color: #f8f9fa;
}

.file-upload-area {
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-upload-area:hover {
    transform: translateY(-2px);
}

.list-group-item {
    border-left: none;
    border-right: none;
}

.list-group-item:first-child {
    border-top: none;
}

.list-group-item:last-child {
    border-bottom: none;
}

/* Right column styling */
.col-4 .card {
    position: sticky;
    top: 20px;
}

.col-4 .list-group-item {
    font-size: 0.875rem;
}
</style>

<div class="modal fade" id="systemPromptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">System Prompt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre class="bg-light p-3 rounded"><code>{{agent.system_prompt}}</code></pre>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="promptTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prompt Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre class="bg-light p-3 rounded"><code>{{agent.prompt_template}}</code></pre>
            </div>
        </div>
    </div>
</div>

{% endblock %}