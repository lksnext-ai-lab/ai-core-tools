{% extends "base.html" %}

{% block content %}


<div class="row">
    <div class="col-10">

        <div class="card shadow mb-4">
            <!-- Card header -->
            <div class="card-header border-bottom">
                <h5 class="mb-0">Playground: {{agent.name}}</h5>
            </div>
            <!-- Card body -->
            <div class="card-body">
                <div class="row">
                    <!-- Information item -->
                    <div class="col-12">
                        <ul class="list-group list-group-borderless">
                            <li class="list-group-item">
                                <span>System prompt: </span>
                                <div class="d-flex align-items-center">
                                    <p class="h6 fw-normal mb-0 text-truncate" style="max-width: 500px;">
                                        {{agent.system_prompt}}</p>
                                    <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal"
                                        data-bs-target="#systemPromptModal">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="col-12">
                        <ul class="list-group list-group-borderless">
                            <li class="list-group-item">
                                <span>Prompt template: </span>
                                <div class="d-flex align-items-center">
                                    <p class="h6 fw-normal mb-0 text-truncate" style="max-width: 500px;">
                                        {{agent.prompt_template}}</p>
                                    <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal"
                                        data-bs-target="#promptTemplateModal">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="col-12">
                        <ul class="list-group list-group-borderless">
                            <li class="list-group-item">
                                <span>Formato de salida: </span>
                                {% if agent.output_parser %}
                                <div class="mt-2">
                                    <p class="mb-2"><strong>Nombre de la clase:</strong> {{agent.output_parser.name}}
                                    </p>
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Nombre del campo</th>
                                                <th>Tipo</th>
                                                <th>Descripción</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for field in agent.output_parser.fields %}
                                            <tr>
                                                <td>{{field.name}}</td>
                                                <td><code>{{field.type}}</code></td>
                                                <td>{{field.description}}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <p class="h6 fw-normal mb-0">None</p>
                                {% endif %}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>


        <div class="card shadow">
            <!-- Card header -->
            <div class="card-header border-bottom">
                <h5 class="card-header-title">Test the agent...</h5>
            </div>

            <!-- Card body START -->
            <div class="card-body">
                <div>
                    <div class="bg-light border border-secondary border-opacity-25 p-3 rounded  mt-4" id="referenece">
                        <!-- Avatar -->
                        <div class="d-sm-flex align-items-center">
                            <div class="avatar avatar-xs flex-shrink-0">
                                <img class="avatar-img rounded-circle" src="/static/img/mattin-small.png" alt="avatar">
                            </div>
                            <!-- Info -->
                            <h6 class="mb-0 ms-2" id="ref-name">{{agent.name}}</h6>
                        </div>
                        <!-- Info -->
                        <div class="hstack gap-4 gap-md-5 flex-wrap mt-2">
                            <div>
                                <p class="mb-0" id="ref-text">Hello, I am {{agent.name}} agent... May I help you?</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="collapseComment">
                    <div class="d-flex mt-3">
                        <textarea id="question" class="form-control mb-0" placeholder="Add a comment..." rows="2"
                            spellcheck="false"></textarea>
                        <button id="send-btn" class="btn btn-sm btn-primary ms-2 px-4 mb-0 flex-shrink-0"><i
                                class="fas fa-paper-plane fs-5"></i></button>
                    </div>
                    {% if agent.silo and agent.silo.metadata_definition %}
                    <div class="mt-3">
                        <h6>Filter by metadata:</h6>
                        <div class="row">
                            {% for field in agent.silo.metadata_definition.fields %}
                            <div class="col-md-4 mb-2">
                                <label for="filter_{{ field.name }}" class="form-label">
                                    <span class="fw-bold">{{ field.name }}</span>
                                    <small class="text-muted d-block">{{ field.description }}</small>
                                </label>
                                <input type="text" class="form-control form-control-sm" 
                                    id="filter_{{ field.name }}" 
                                    data-field-type="{{ field.type }}">
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

            </div>
            <!-- Card body END -->
        </div>


    </div>

</div>

<script>
    var cont = 0;
    $('#send-btn').click(function () {
        // Deshabilitar el botón mientras se procesa
        $('#send-btn').prop('disabled', true);
        
        var question = $('#question').val();
        console.log('Sending question:', question);
        
        // Limpiar el input inmediatamente después de obtener su valor
        $('#question').val('');

        // Collect filter values if they exist
        var search_params = null;
        {% if agent.silo and agent.silo.metadata_definition %}
        var filter = {};
        {% for field in agent.silo.metadata_definition.fields %}
        var value = $('#filter_{{ field.name }}').val();
        if (value) {
            filter['{{ field.name }}'] = {"$eq": value};
        }
        {% endfor %}
        if (Object.keys(filter).length > 0) {
            search_params = { filter: filter };
        }
        {% endif %}
        
        // Crear y mostrar el div de la pregunta
        var qDiv = $('#referenece').clone();
        qDiv.attr('id', 'referenece-' + cont);
        cont++;
        $('#ref-name', qDiv).text('You said...');
        $('#ref-text', qDiv).text(question);
        $('#referenece').parent().append(qDiv);

        // Crear y mostrar un div de "loading"
        var loadingDiv = $('#referenece').clone();
        loadingDiv.attr('id', 'loading-' + cont);
        $('#ref-name', loadingDiv).text('{{agent.name}}');
        $('#ref-text', loadingDiv).html('<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2" role="status"></div>Thinking...</div>');
        $('#referenece').parent().append(loadingDiv);

        $("html, body").animate({
            scrollTop: $(document).height() - $(window).height()
        }, 'slow');

        // Hacer la petición con timeout
        const timeoutDuration = 600000; // 10 minutos
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutDuration);

        fetch('/api/app/{{app_id}}/call/{{agent.agent_id}}', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                question: question,
                search_params: search_params
            }),
            signal: controller.signal
        })
        .then(async response => {
            clearTimeout(timeoutId);
            if (!response.ok) {
                // Intentar obtener el mensaje de error del servidor
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `Error del servidor: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Eliminar el div de loading
            loadingDiv.remove();
            
            // Crear el div de respuesta
            var respDiv = $('#referenece').clone();
            respDiv.attr('id', 'referenece-' + cont);
            cont++;
            $('#ref-text', respDiv).text(JSON.stringify(data["generated_text"], null, 2));
            $('#referenece').parent().append(respDiv);

            $("html, body").animate({
                scrollTop: $(document).height() - $(window).height()
            }, 'slow');
        })
        .catch(error => {
            // Eliminar el div de loading
            loadingDiv.remove();
            
            // Mostrar error en un nuevo div con más detalles
            var errorDiv = $('#referenece').clone();
            errorDiv.attr('id', 'error-' + cont);
            $('#ref-name', errorDiv).text('Error');
            $('#ref-text', errorDiv).html(`
                <div class="text-danger">
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><small>Si el problema persiste, por favor contacte al administrador.</small></p>
                </div>
            `);
            $('#referenece').parent().append(errorDiv);
            
            console.error('Error detallado:', error);
        })
        .finally(() => {
            // Solo habilitar el botón ya que el input se limpió antes
            $('#send-btn').prop('disabled', false);
        });
    });

</script>

<div class="modal fade" id="systemPromptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">System Prompt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre class="bg-light p-3 rounded"><code>{{agent.system_prompt}}</code></pre>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="promptTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prompt Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre class="bg-light p-3 rounded"><code>{{agent.prompt_template}}</code></pre>
            </div>
        </div>
    </div>
</div>

{% endblock %}