{% extends "base.html" %}

{% block content %}

<div class="row">
    <!-- Left Column: Chat Interface -->
    <div class="col-8">

        <div class="card shadow mb-4">
            <!-- Card header -->
            <div class="card-header border-bottom">
                <h5 class="mb-0">Playground: {{agent.name}}</h5>
            </div>
            <!-- Card body -->
            <div class="card-body">
                <div class="row">
                    <!-- Information item -->
                    <div class="col-12">
                        <ul class="list-group list-group-borderless">
                            <li class="list-group-item">
                                <span>System prompt: </span>
                                <div class="d-flex align-items-center">
                                    <p class="h6 fw-normal mb-0 text-truncate" style="max-width: 500px;">
                                        {{agent.system_prompt}}</p>
                                    <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal"
                                        data-bs-target="#systemPromptModal">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="col-12">
                        <ul class="list-group list-group-borderless">
                            <li class="list-group-item">
                                <span>Prompt template: </span>
                                <div class="d-flex align-items-center">
                                    <p class="h6 fw-normal mb-0 text-truncate" style="max-width: 500px;">
                                        {{agent.prompt_template}}</p>
                                    <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal"
                                        data-bs-target="#promptTemplateModal">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="col-12">
                        <ul class="list-group list-group-borderless">
                            <li class="list-group-item">
                                <span>Formato de salida: </span>
                                {% if agent.output_parser %}
                                <div class="mt-2">
                                    <p class="mb-2"><strong>Nombre de la clase:</strong> {{agent.output_parser.name}}
                                    </p>
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Nombre del campo</th>
                                                <th>Tipo</th>
                                                <th>Descripci√≥n</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for field in agent.output_parser.fields %}
                                            <tr>
                                                <td>{{field.name}}</td>
                                                <td><code>{{field.type}}</code></td>
                                                <td>{{field.description}}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <p class="h6 fw-normal mb-0">None</p>
                                {% endif %}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow">
            <!-- Card header -->
            <div class="card-header border-bottom">
                <h5 class="card-header-title">Test the agent...</h5>
                <button id="reset-btn" class="btn btn-sm btn-outline-danger float-end">
                    <i class="fas fa-trash"></i> Reset Conversation
                </button>
            </div>

            <!-- Card body START -->
            <div class="card-body">
                <div>
                    <div class="bg-light border border-secondary border-opacity-25 p-3 rounded  mt-4" id="referenece">
                        <!-- Avatar -->
                        <div class="d-sm-flex align-items-center">
                            <div class="avatar avatar-xs flex-shrink-0">
                                <img class="avatar-img rounded-circle" src="/static/img/mattin-small.png" alt="avatar">
                            </div>
                            <!-- Info -->
                            <h6 class="mb-0 ms-2" id="ref-name">{{agent.name}}</h6>
                        </div>
                        <!-- Info -->
                        <div class="hstack gap-4 gap-md-5 flex-wrap mt-2">
                            <div>
                                <p class="mb-0" id="ref-text">Hello, I am {{agent.name}} agent... May I help you?</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="collapseComment">
                    
                    <div class="d-flex mt-3">
                        <textarea id="question" class="form-control mb-0" placeholder="Add a comment..." rows="2"
                            spellcheck="false"></textarea>
                        <button id="send-btn" class="btn btn-sm btn-primary ms-2 px-4 mb-0 flex-shrink-0"><i
                                class="fas fa-paper-plane fs-5"></i></button>
                    </div>
                    {% if agent.silo and agent.silo.metadata_definition %}
                    <div class="mt-3">
                        <h6>Filter by metadata:</h6>
                        <div class="row">
                            {% for field in agent.silo.metadata_definition.fields %}
                            <div class="col-md-4 mb-2">
                                <label for="filter_{{ field.name }}" class="form-label">
                                    <span class="fw-bold">{{ field.name }}</span>
                                    <small class="text-muted d-block">{{ field.description }}</small>
                                </label>
                                <input type="text" class="form-control form-control-sm" 
                                    id="filter_{{ field.name }}" 
                                    data-field-type="{{ field.type }}">
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

            </div>
            <!-- Card body END -->
        </div>

    </div>

    <!-- Right Column: File Management -->
    <div class="col-4">
        <div class="card shadow">
            <div class="card-header border-bottom">
                <h6 class="mb-0">
                    <i class="fas fa-paperclip"></i> File Attachments
                </h6>
            </div>
            <div class="card-body">
                
                <!-- File Upload Section -->
                <div class="mb-3">
                    <div class="card border-dashed">
                        <div class="card-body text-center p-3">
                            <div class="file-upload-area" id="fileUploadArea">
                                <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                <h6 class="mb-1">Drag & Drop files</h6>
                                <p class="text-muted mb-2 small">or click to browse</p>
                                <input type="file" id="fileInput" multiple class="d-none" accept=".pdf,.txt,.md,.png,.jpg,.jpeg,.doc,.docx">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-folder-open"></i> Choose Files
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attached Files List -->
                <div id="attachedFilesSection" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Attached Files</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="clearAllFiles">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                    <div id="attachedFilesList" class="list-group list-group-flush">
                        <!-- Files will be added here dynamically -->
                    </div>
                </div>

                <!-- File Info -->
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Supported formats: PDF, TXT, MD, PNG, JPG, DOC, DOCX
                    </small>
                </div>

            </div>
        </div>
    </div>

</div>

<script>
    // Configuration variables for the playground
    var appId = '{{app_id}}';
    var agentId = '{{agent.agent_id}}';
    var agentName = '{{agent.name}}';
    
    // Filter fields configuration (if available)
    {% if agent.silo and agent.silo.metadata_definition %}
    var filterFields = [
        {% for field in agent.silo.metadata_definition.fields %}
        {
            name: '{{ field.name }}',
            type: '{{ field.type }}',
            description: '{{ field.description }}'
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    {% else %}
    var filterFields = [];
    {% endif %}
</script>

<div class="modal fade" id="systemPromptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">System Prompt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre class="bg-light p-3 rounded"><code>{{agent.system_prompt}}</code></pre>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="promptTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prompt Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre class="bg-light p-3 rounded"><code>{{agent.prompt_template}}</code></pre>
            </div>
        </div>
    </div>
</div>

{% endblock %}