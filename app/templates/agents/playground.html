{% extends "base.html" %}

{% block content %}

<div class="row">
    <!-- Left Column: Chat Interface -->
    <div class="col-8">

        <div class="card shadow mb-4">
            <!-- Card header -->
            <div class="card-header border-bottom">
                <h5 class="mb-0">Playground: {{agent.name}}</h5>
            </div>
            <!-- Card body -->
            <div class="card-body">
                <div class="row">
                    <!-- System Prompt -->
                    <div class="col-6 mb-3">
                        <h6 class="text-primary mb-2"><i class="fas fa-terminal"></i> System Prompt</h6>
                        <div class="d-flex align-items-center">
                            <p class="h6 fw-normal mb-0 text-truncate" id="systemPromptPreview" style="max-width: 400px;">
                                {{agent.system_prompt}}</p>
                            <button class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#systemPromptModal">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Prompt Template -->
                    <div class="col-6 mb-3">
                        <h6 class="text-primary mb-2"><i class="fas fa-file-code"></i> Prompt Template</h6>
                        <div class="d-flex align-items-center">
                            <p class="h6 fw-normal mb-0 text-truncate" id="promptTemplatePreview" style="max-width: 400px;">
                                {{agent.prompt_template}}</p>
                            <button class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#promptTemplateModal">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Output Parser -->
                    {% if agent.output_parser %}
                    <div class="col-12 mb-3">
                        <h6 class="text-primary mb-2"><i class="fas fa-cogs"></i> Output Parser</h6>
                        <div class="mt-2">
                            <p class="mb-2"><strong>Name:</strong> {{agent.output_parser.name}}</p>
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Field Name</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for field in agent.output_parser.fields %}
                                    <tr>
                                        <td>{{field.name}}</td>
                                        <td><code>{{field.type}}</code></td>
                                        <td>{{field.description}}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card shadow">
            <!-- Card header -->
            <div class="card-header border-bottom d-flex justify-content-between align-items-center">
                <h5 class="card-header-title mb-0">
                    <i class="fas fa-comments"></i> Test the agent...
                </h5>
                <div>
                    <button id="reset-btn" class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-trash"></i> Reset Conversation
                    </button>
                </div>
            </div>

            <!-- Card body START -->
            <div class="card-body">
                <!-- Conversation History -->
                <div class="mb-3">
                    <div class="bg-light border border-secondary border-opacity-25 p-3 rounded" id="referenece">
                        <!-- Avatar -->
                        <div class="d-flex align-items-center">
                            <div class="avatar avatar-xs flex-shrink-0">
                                <img class="avatar-img rounded-circle" src="/static/img/mattin-small.png" alt="avatar">
                            </div>
                            <!-- Info -->
                            <div class="ms-2">
                                <h6 class="mb-0" id="ref-name">{{agent.name}}</h6>
                                <small class="text-muted">Agent</small>
                            </div>
                        </div>
                        <!-- Message -->
                        <div class="mt-2">
                            <p class="mb-0" id="ref-text">Hello, I am {{agent.name}} agent... May I help you?</p>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="collapseComment">
                    
                    <div class="d-flex mt-3">
                        <textarea id="question" class="form-control mb-0" placeholder="Type your message here... (Enter to send, Ctrl+Enter for new line)" rows="2"
                            spellcheck="false"></textarea>
                        <button id="send-btn" class="btn btn-primary ms-2 px-4 mb-0 flex-shrink-0">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    {% if agent.silo and agent.silo.metadata_definition %}
                    <div class="mt-3">
                        <div class="card border-info">
                            <div class="card-header bg-info bg-opacity-10 border-info" 
                                 data-bs-toggle="collapse" 
                                 data-bs-target="#metadataFilterCollapse" 
                                 aria-expanded="false" 
                                 aria-controls="metadataFilterCollapse"
                                 style="cursor: pointer;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 text-info">
                                        <i class="fas fa-filter"></i> Filter by metadata
                                    </h6>
                                    <i class="fas fa-chevron-down text-info"></i>
                                </div>
                            </div>
                            <div class="collapse" id="metadataFilterCollapse">
                                <div class="card-body">
                                    <div class="row">
                                        {% for field in agent.silo.metadata_definition.fields %}
                                        <div class="col-md-4 mb-2">
                                            <label for="filter_{{ field.name }}" class="form-label">
                                                <span class="fw-bold">{{ field.name }}</span>
                                                <small class="text-muted d-block">{{ field.description }}</small>
                                            </label>
                                            <input type="text" class="form-control form-control-sm" 
                                                id="filter_{{ field.name }}" 
                                                data-field-type="{{ field.type }}"
                                                placeholder="Enter {{ field.name }}">
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

            </div>
            <!-- Card body END -->
        </div>

    </div>

    <!-- Right Column: Agent Info & File Management -->
    <div class="col-4">
        <!-- Agent Information Card -->
        <div class="card shadow mb-4">
            <div class="card-header border-bottom">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle"></i> Agent Information
                </h6>
            </div>
            <div class="card-body">
                <!-- Agent Basic Information -->
                <div class="mb-3">
                    <div class="row">
                        <div class="col-6">
                            <p class="mb-1"><strong>Type:</strong></p>
                            <span class="badge bg-secondary">{{agent.type}}</span>
                        </div>
                        <div class="col-6">
                            <p class="mb-1"><strong>Status:</strong></p>
                            <span class="badge bg-{{'success' if agent.status == 'active' else 'warning'}}">{{agent.status}}</span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6">
                            <p class="mb-1"><strong>Requests:</strong></p>
                            <span class="badge bg-info">{{agent.request_count}}</span>
                        </div>
                        <div class="col-6">
                            <p class="mb-1"><strong>Memory:</strong></p>
                            <span class="badge bg-{{'success' if agent.has_memory else 'secondary'}}">{{'Yes' if agent.has_memory else 'No'}}</span>
                        </div>
                    </div>
                </div>

                <!-- AI Service Information -->
                {% if agent.ai_service %}
                <div class="mb-3">
                    <h6 class="text-primary mb-2"><i class="fas fa-robot"></i> AI Service</h6>
                    <div class="row">
                        <div class="col-6">
                            <p class="mb-1"><strong>Provider:</strong></p>
                            <span class="badge bg-info">{{agent.ai_service.provider}}</span>
                        </div>
                        <div class="col-6">
                            <p class="mb-1"><strong>Name:</strong></p>
                            <span class="text-truncate d-block small">{{agent.ai_service.name}}</span>
                        </div>
                    </div>
                    {% if agent.ai_service.api_version %}
                    <div class="row mt-2">
                        <div class="col-12">
                            <p class="mb-1"><strong>API Version:</strong></p>
                            <span class="badge bg-secondary">{{agent.ai_service.api_version}}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Silo Information -->
                {% if agent.silo %}
                <div class="mb-3">
                    <h6 class="text-primary mb-2"><i class="fas fa-database"></i> Connected Silo</h6>
                    <div class="row">
                        <div class="col-6">
                            <p class="mb-1"><strong>Name:</strong></p>
                            <span class="text-truncate d-block small">{{agent.silo.name}}</span>
                        </div>
                        <div class="col-6">
                            <p class="mb-1"><strong>Type:</strong></p>
                            <span class="badge bg-warning">{{agent.silo.silo_type}}</span>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Tools and MCPs -->
                {% if agent.tool_associations or agent.mcp_associations %}
                <div class="mb-3">
                    <h6 class="text-primary mb-2"><i class="fas fa-tools"></i> Tools & MCPs</h6>
                    {% if agent.tool_associations %}
                    <div class="mb-2">
                        <p class="mb-1"><strong>Tools ({{agent.tool_associations|length}}):</strong></p>
                        <div class="d-flex flex-wrap gap-1">
                            {% for tool_assoc in agent.tool_associations %}
                            <span class="badge bg-success small">{{tool_assoc.tool.name}}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% if agent.mcp_associations %}
                    <div class="mb-2">
                        <p class="mb-1"><strong>MCPs ({{agent.mcp_associations|length}}):</strong></p>
                        <div class="d-flex flex-wrap gap-1">
                            {% for mcp_assoc in agent.mcp_associations %}
                            <span class="badge bg-info small">{{mcp_assoc.mcp.name}}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- File Attachments Card -->
        <div class="card shadow">
            <div class="card-header border-bottom">
                <h6 class="mb-0">
                    <i class="fas fa-paperclip"></i> File Attachments
                </h6>
            </div>
            <div class="card-body">
                
                <!-- File Upload Section -->
                <div class="mb-3">
                    <div class="card border-dashed">
                        <div class="card-body text-center p-3">
                            <div class="file-upload-area" id="fileUploadArea">
                                <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                <h6 class="mb-1">Drag & Drop files</h6>
                                <p class="text-muted mb-2 small">or click to browse</p>
                                <input type="file" id="fileInput" multiple class="d-none" accept=".pdf,.txt,.md,.png,.jpg,.jpeg,.doc,.docx">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-folder-open"></i> Choose Files
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attached Files List -->
                <div id="attachedFilesSection" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Attached Files</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="clearAllFiles">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                    <div id="attachedFilesList" class="list-group list-group-flush">
                        <!-- Files will be added here dynamically -->
                    </div>
                </div>

                <!-- File Info -->
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Supported formats: PDF, TXT, MD, PNG, JPG, DOC, DOCX
                    </small>
                </div>

            </div>
        </div>
    </div>

</div>

<!-- Hidden input for filter fields data -->
{% if agent.silo and agent.silo.metadata_definition %}
<input type="hidden" id="filterFieldsData" value='[
    {% for field in agent.silo.metadata_definition.fields %}
    {"name": "{{ field.name }}", "type": "{{ field.type }}", "description": "{{ field.description }}"}
    {%- if not loop.last %},{% endif -%}
    {% endfor %}
]'>
{% endif %}

<script>
    // Configuration variables for the playground
    var appId = '{{app_id}}';
    var agentId = '{{agent.agent_id}}';
    var agentName = '{{agent.name}}';
    
    // Filter fields configuration (if available)
    var filterFields = [];
    var filterFieldsInput = document.getElementById('filterFieldsData');
    if (filterFieldsInput) {
        try {
            filterFields = JSON.parse(filterFieldsInput.value);
        } catch (e) {
            console.warn('Failed to parse filter fields data:', e);
        }
    }



    // Handle metadata filter collapse animation
    document.addEventListener('DOMContentLoaded', function() {
        const metadataFilterCollapse = document.getElementById('metadataFilterCollapse');
        const chevronIcon = document.querySelector('[data-bs-target="#metadataFilterCollapse"] .fas.fa-chevron-down');
        
        if (metadataFilterCollapse && chevronIcon) {
            metadataFilterCollapse.addEventListener('show.bs.collapse', function() {
                chevronIcon.style.transform = 'rotate(180deg)';
                chevronIcon.style.transition = 'transform 0.3s ease';
            });
            
            metadataFilterCollapse.addEventListener('hide.bs.collapse', function() {
                chevronIcon.style.transform = 'rotate(0deg)';
                chevronIcon.style.transition = 'transform 0.3s ease';
            });
        }


    });



    // Save System Prompt
    function saveSystemPrompt() {
        const newPrompt = document.getElementById('systemPromptEditor').value;
        const saveBtn = event.target;
        const originalText = saveBtn.innerHTML;
        
        // Show loading state
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        saveBtn.disabled = true;
        
        fetch(`/agents/${agentId}/update-prompt`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
            },
            body: JSON.stringify({
                type: 'system',
                prompt: newPrompt
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the displayed prompt
                document.getElementById('systemPromptPreview').textContent = newPrompt;
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('systemPromptModal')).hide();
                // Show success message
                showToast('System prompt updated successfully!', 'success');
                
                // Reset conversation since agent behavior has changed
                resetConversation();
            } else {
                showToast(data.error || 'Failed to update system prompt', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred while saving the prompt', 'error');
        })
        .finally(() => {
            // Reset button state
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        });
    }

    // Save Prompt Template
    function savePromptTemplate() {
        const newTemplate = document.getElementById('promptTemplateEditor').value;
        const saveBtn = event.target;
        const originalText = saveBtn.innerHTML;
        
        // Show loading state
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        saveBtn.disabled = true;
        
        fetch(`/agents/${agentId}/update-prompt`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
            },
            body: JSON.stringify({
                type: 'template',
                prompt: newTemplate
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the displayed prompt
                document.getElementById('promptTemplatePreview').textContent = newTemplate;
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('promptTemplateModal')).hide();
                // Show success message
                showToast('Prompt template updated successfully!', 'success');
                
                // Reset conversation since agent behavior has changed
                resetConversation();
            } else {
                showToast(data.error || 'Failed to update prompt template', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred while saving the template', 'error');
        })
        .finally(() => {
            // Reset button state
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        });
    }

    // Reset conversation function
    function resetConversation() {
        // Disable reset button while processing
        const resetBtn = document.getElementById('reset-btn');
        if (resetBtn) {
            resetBtn.disabled = true;
        }
        
        fetch('/api/app/' + appId + '/reset/' + agentId, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to reset conversation');
            }
            return response.json();
        })
        .then(data => {
            // Remove all conversation divs except the initial one
            document.querySelectorAll('[id^="referenece-"]').forEach(el => el.remove());
            document.querySelectorAll('[id^="loading-"]').forEach(el => el.remove());
            document.querySelectorAll('[id^="error-"]').forEach(el => el.remove());
            
            // Clear attached files if the function exists
            if (typeof attachedFiles !== 'undefined') {
                attachedFiles.clear();
                const attachedFilesList = document.getElementById('attachedFilesList');
                if (attachedFilesList) {
                    attachedFilesList.innerHTML = '';
                }
                if (typeof updateAttachedFilesVisibility === 'function') {
                    updateAttachedFilesVisibility();
                }
            }
            
            // Show success message
            const referenceDiv = document.getElementById('referenece');
            if (referenceDiv) {
                const successDiv = referenceDiv.cloneNode(true);
                successDiv.id = 'success-reset';
                const nameElement = successDiv.querySelector('#ref-name');
                const textElement = successDiv.querySelector('#ref-text');
                if (nameElement) nameElement.textContent = 'System';
                if (textElement) textElement.innerHTML = '<div class="text-success">Conversation reset due to prompt changes</div>';
                referenceDiv.parentNode.appendChild(successDiv);
                
                // Remove success message after 3 seconds
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error resetting conversation:', error);
            showToast('Failed to reset conversation. Please try again.', 'error');
        })
        .finally(() => {
            // Re-enable reset button
            if (resetBtn) {
                resetBtn.disabled = false;
            }
        });
    }

    // Toast notification function
    function showToast(message, type = 'info') {
        // Create toast element
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        // Add to page
        const toastContainer = document.getElementById('toastContainer') || createToastContainer();
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // Show toast
        const toastElement = toastContainer.lastElementChild;
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // Remove after hidden
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }

    // Create toast container if it doesn't exist
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    }


</script>

<div class="modal fade" id="systemPromptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit System Prompt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="systemPromptEditor" class="form-label">System Prompt</label>
                    <textarea id="systemPromptEditor" class="form-control" rows="12" placeholder="Enter the system prompt...">{{agent.system_prompt}}</textarea>
                    <div class="form-text">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            This prompt defines the agent's behavior and capabilities.
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSystemPrompt()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="promptTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Prompt Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="promptTemplateEditor" class="form-label">Prompt Template</label>
                    <textarea id="promptTemplateEditor" class="form-control" rows="12" placeholder="Enter the prompt template...">{{agent.prompt_template}}</textarea>
                    <div class="form-text">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            This template defines how user input is formatted before sending to the AI.
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePromptTemplate()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}