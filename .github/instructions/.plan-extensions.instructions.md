---
description: Workflow for extending completed plans with new features
applyTo: "plans/**"
---

# Plan Extension Workflow

## Overview

When a plan is completed and executed, you may discover new requirements, edge cases, or related features that should be added. Rather than reopening the original plan, **extensions** allow you to add new features while maintaining context and continuous step numbering.

This workflow applies to both the Feature Planner (`@feature-planner`) and Plan Executor (`@plan-executor`) agents.

## Extension Concepts

### Extension Files

Extensions are stored as separate plan files alongside the original plan:

```
plans/
└── agent-marketplace/           # Original plan folder
    ├── spec.md                  # Original specification (unchanged)
    ├── decisions.md
    ├── open-questions.md
    ├── execution/
    │   ├── step_000_plan.md     # Original execution overview
    │   ├── step_001.md through step_024.md  # Original steps
    │   └── status.yaml          # Single status file tracking all steps
    │
    ├── execution/extensions/    # NEW: Extensions folder
    │   ├── extension-1.plan.md  # First extension specification
    │   ├── extension-2.plan.md  # Second extension specification
    │   └── extension-N.plan.md  # Nth extension
```

### Extension Numbering

- Extension plan files: `extension-1.plan.md`, `extension-2.plan.md`, etc.
- **Step numbering continues globally**: If the original plan ended at step 024, the first extension starts at step 025
- Single `status.yaml` tracks all steps (original + extensions)
- Extensions do NOT reset step numbering — maintains unified execution view

### Extension Relationships

Extensions must explicitly reference the original plan:
- File header includes `parent_plan: agent-marketplace` and `extension_id: 1`
- Extension spec may reference original spec sections
- Extension requirements should be related to (but not duplicate) original requirements

## Feature Planner Extension Workflow (`@feature-planner`)

### When to Create an Extension

1. **Plan is completed** (original spec fully executed)
2. **New conversation** with user identifies additional features
3. **Related to original plan** — Extensions are for closely related features, not unrelated new work
4. **Clear separation** — Each extension is a distinct feature that could be scoped separately

### Creating an Extension

**User invocation**:
```
@feature-planner extend the agent-marketplace plan with extension-1: <description>
```

**Planner workflow**:

1. **Validate parent plan exists**:
   - Check `/plans/agent-marketplace/spec.md` exists
   - Read execution status from `execution/status.yaml`
   - Confirm original plan is `implemented` or near completion

2. **Create extension directory**:
   - Ensure `/plans/agent-marketplace/execution/extensions/` exists
   - Create new extension file: `/plans/agent-marketplace/execution/extensions/extension-1.plan.md`

3. **Write extension spec** following template (see below)

4. **Reference original plan**:
   - In the extension header, include `parent_plan: agent-marketplace` and `extension_id: 1`
   - Reference relevant original requirements (e.g., "Builds on FR-4, AC-6 from original spec")

5. **Note next step number**:
   - Read `execution/status.yaml` to find the last completed step
   - Include in extension header: `next_step_number: 025` (for documentation)

6. **Guide user to Executor**:
   - After extension spec is ready, user invokes `@plan-executor` to execute it

### Extension Spec Template

```markdown
# Agent Marketplace - Extension 1: Analytics Dashboard

> **Status**: ready
> **Parent Plan**: agent-marketplace
> **Extension ID**: 1
> **Created**: 2026-03-01
> **Links To Original**: FR-1, FR-2, FR-3 (see ../spec.md)
> **Next Step Number**: 025

## Context

This extension builds on the marketplace foundation to add real-time usage analytics and agent performance metrics.

## Goals

[Goals for this extension]

## Functional Requirements

### FR-E1-1: Usage Tracking (Extension)

[Requirement]

### FR-E1-2: Dashboard UI (Extension)

[Requirement]

## Acceptance Criteria

[Acceptance criteria]

## Edge Cases & Constraints

[Edge cases]

## Dependencies

- [Depends on original agent-marketplace plan completion]

## Open Questions

[Any unresolved questions]
```

**Naming convention for extension requirements**:
- Use `FR-E{extension_id}-{number}` (e.g., `FR-E1-1`, `FR-E1-2` for extension 1)
- Use `AC-E{extension_id}-{number}` (e.g., `AC-E1-1`, `AC-E1-2` for extension 1)
- This distinguishes extension requirements from original requirements

---

## Plan Executor Extension Workflow (`@plan-executor`)

### When Executing an Extension

**User invocation**:
```
@plan-executor execute extension agent-marketplace extension-1
```

**Executor workflow**:

1. **Read extension spec**:
   - Load `/plans/agent-marketplace/execution/extensions/extension-1.plan.md`
   - Extract parent plan reference and next step number

2. **Read current status**:
   - Open `/plans/agent-marketplace/execution/status.yaml`
   - Find the last completed step number
   - Verify next step number from extension matches expected continuation

3. **Continue step numbering**:
   - If status.yaml shows step 024 was completed, extension steps start at 025
   - Steps follow same format: `step_NNN.md` (step_025.md, step_026.md, etc.)
   - All steps added to the same `status.yaml` file

4. **Create steps**:
   - Generate steps folder in `execution/steps/` (or same level as original steps)
   - Name consistently: `step_025.md`, `step_026.md` (continue from original)

5. **Update status.yaml**:
   - Add new steps to existing `status.yaml`
   - Include `extension_reference: extension-1` field in each extension step
   - Preserve all original step entries

6. **Reference parent context**:
   - Each extension step includes context reference: "Executing extension-1 of agent-marketplace plan"
   - Step descriptions may reference original requirements/decisions
   - Agents understand the foundational work that came before

### Status File Format with Extensions

```yaml
# plans/agent-marketplace/execution/status.yaml
plan_id: agent-marketplace
overall_status: in-progress
execution_mode: extended  # Indicates extensions are being executed

# Original steps (unchanged)
steps:
  - step: "001"
    title: "Create feature branch"
    status: done
    # ... rest of original steps 001-024

  # Extension-1 steps (continuation)
  - step: "025"
    title: "[Extension-1] Build analytics backend"
    target_agent: "@backend-expert"
    status: not-started
    extension_reference: extension-1
    fr: ["FR-E1-1"]
    ac: ["AC-E1-1", "AC-E1-2"]

  - step: "026"
    title: "[Extension-1] Create analytics dashboard UI"
    target_agent: "@react-expert"
    status: not-started
    extension_reference: extension-1
    fr: ["FR-E1-2"]
    ac: ["AC-E1-3"]
    depends_on: ["025"]

  # Extension-2 steps follow Extension-1
  - step: "027"
    title: "[Extension-2] Add performance monitoring"
    target_agent: "@backend-expert"
    status: not-started
    extension_reference: extension-2
    # ...
```

### Key Points

- **Single `status.yaml`**: All original + extension steps in one file
- **Continuous numbering**: 001...024 (original), 025+ (extension-1), continuing through all extensions
- **Extension markers**: Use `[Extension-N]` prefix in step titles and `extension_reference` field for clarity
- **No separate execution directories**: Extensions live in `/execution/extensions/` for specs, but steps stay in main `execution/` directory
- **Resume capability**: Executor can resume from any point across original + extensions seamlessly

---

## Converting Extensions to a New Plan

If an extension grows significantly or becomes independent, it can be **promoted** to a standalone plan:

1. Copy extension spec to new plan folder: `/plans/new-feature-name/spec.md`
2. Mark original extension as `archived` or `superseded`
3. Create new execution folder for promoted plan: `/plans/new-feature-name/execution/`
4. Start fresh step numbering (001+) for the promoted plan

---

## Best Practices

### For Feature Planner

- ✅ Always validate parent plan exists and is complete before creating extension
- ✅ Reference original FR/AC by number to show relationship
- ✅ Use consistent naming: `FR-E{id}-{num}`, `AC-E{id}-{num}`
- ✅ Include `next_step_number` in extension header for clarity
- ✅ Create extension only when scope is clear and ready to implement

### For Plan Executor

- ✅ Always read parent plan context before generating extension steps
- ✅ Maintain continuous step numbering across original + all extensions
- ✅ Use `[Extension-N]` prefixes in step titles for visual clarity
- ✅ Include `extension_reference` field in all extension steps
- ✅ Never create separate `status.yaml` files — single file tracks everything
- ✅ Add context notes to agents about parent plan when relevant

### For Developers

- ✅ Extensions are for **related features** discovered after plan completion
- ✅ Unrelated features should be new plans, not extensions
- ✅ Use extensions to refine/improve the original without losing context
- ✅ Can create multiple extensions (extension-1, extension-2, etc.) as needed
- ✅ Extensions inherit all decisions/constraints from parent plan

