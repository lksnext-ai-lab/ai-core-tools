---
description: Conventions and rules for Alembic migration files in the alembic/versions/ directory
applyTo: "alembic/**"
---

# Alembic Migration Conventions

These instructions are auto-applied to all files under `alembic/**`. For deeper expertise, migration workflows, troubleshooting, and project-specific patterns, use the `@alembic-expert` agent.

## Migration File Rules

- Every migration MUST have both `upgrade()` and `downgrade()` functions
- The `downgrade()` function MUST fully reverse all changes made by `upgrade()`
- Use descriptive revision messages: `"add_memory_management_fields"`, not `"update"`
- Verify `down_revision` points to the correct parent migration before committing
- Never modify an existing migration that has already been applied â€” create a new one instead

## Table Naming

- Primary entity tables use **PascalCase**: `Agent`, `Silo`, `App`, `Skill`
- Junction/association tables use **snake_case**: `agent_skills`, `agent_mcps`, `agent_tools`

## Column Conventions

- Primary keys follow the pattern `<table_name_lower>_id` (e.g., `skill_id`, `agent_id`)
- Always be explicit about `nullable=True` or `nullable=False`
- When adding a non-nullable column to an existing table, provide a `server_default`
- Use `sa.DateTime()` for timestamps, with `default=datetime.now` in the model
- Foreign keys must reference the full `TableName.column_name` format

## Model Registration

- When a migration creates a table for a new model, ensure the model class is imported in `backend/models/__init__.py`
- Without this import, Alembic autogenerate will not detect the model

## Ignored Tables

- `langchain_pg_collection` and `langchain_pg_embedding` are managed by LangChain and excluded from autogeneration via the `include_name()` filter in `alembic/env.py`
- Do NOT create migrations for these tables
